# Sales Order Management SaaS Plan

## Core Entities

1. **Product**

- Code (e.g., GV011)
- Name / Description
- Category (for grouping products, optional for future expansions)
- Supplier ID (for vendor tracking, optional FK to a suppliers table)
- Wholesale price (excl. GST)
- Retail price (incl. GST)
- Tax rate (for dynamic GST calculations, if needed)
- Stock quantity (inventory level)

2. **Sales Order**

- Order ID
- Customer info (business name, contact person, email)
- Shipping address (for delivery details)
- Delivery date (estimated or required)
- Salesperson ID (user creating/updating the order)
- Order date
- Status: Draft → Submitted → Approved → Fulfilled → Rejected
- Notes (free text, e.g., warehouse remarks)
- Attachments (packing proof photo, etc.)

3. **Order Line Item**

- Product Code
- Product Name
- Unit Price (from wholesale price list)
- Quantity Ordered
- Line total = price × quantity
- Inventory availability flag (in stock / out of stock, editable or read-only)
- Line status (e.g., pending, fulfilled, backordered—for partial fulfillment support)

4. **Users & Roles**

- Salesperson: Create/update orders (Draft, Submit).
- Manager: Approve or reject submitted orders.
- Warehouse Staff: View orders, add notes, upload proof of packing, update fulfillment status.

## Workflow (State Machine)

- **Draft** → Created by salesperson. Editable.
- **Submitted** → System validates stock availability. If items exceed stock, mark them as “out of stock” (highlight red, read-only). Then salesperson submits.
- **Approved** → Manager reviews and approves/rejects. Re-validate stock dynamically on approval.
- **Fulfilled** → Warehouse updates order status, adds notes, uploads proof. Automatically deduct stock from inventory on fulfillment.
- **Rejected** → Reverts to Draft for edits/corrections (loop back to allow revisions without recreating orders).

**Additional**: Support partial fulfillment by updating per-line-item statuses. Track status changes in an audit history for compliance.

## Validation Rules

1. Sales order line item quantity cannot exceed available inventory (enforced client-side for UX and server-side for security).
2. Out-of-stock items are locked (not editable).
3. Salesperson can always view and update draft/submitted orders.
4. Manager can approve only if at least one item is valid (consider adding a threshold for minimum valid items to avoid near-empty orders).
5. Warehouse can only update notes, status, and attachments — not pricing or quantities.
6. Prevent negative quantities or prices.
7. Validate email formats in customer info.
8. Recalculate line_total on updates to prevent tampering.
9. Re-validate stock dynamically on approval/fulfillment to handle real-time changes.

## API Endpoints (Serverless, Next.js API Routes)

- `POST /api/v1/orders` → Create draft order.
- `PUT /api/v1/orders/:id` → Update order (Draft only).
- `POST /api/v1/orders/:id/submit` → Submit for approval (validates stock).
- `POST /api/v1/orders/:id/approve` → Manager approves order (re-validates stock).
- `POST /api/v1/orders/:id/reject` → Manager rejects order (reverts to Draft).
- `POST /api/v1/orders/:id/warehouse` → Warehouse updates notes/status/attachments (triggers stock deduction on fulfillment).
- `GET /api/v1/orders/:id` → View order details (dynamically recomputes stock flags if needed).
- `GET /api/v1/orders` → List orders (filtered by role/permissions; supports query params like `?status=submitted&salesperson_id=uuid&page=1&limit=20` for filtering/pagination).
- `GET /api/v1/products` → List/search products (with stock info).
- `GET /api/v1/users` → Manage users/roles (admin only).

**Additional**: Implement authentication (e.g., Supabase Auth JWT) and RBAC middleware for all endpoints. Use idempotency keys for action endpoints (e.g., `/submit`) to prevent duplicates.

## Database Schema (Supabase/Postgres)

1. **products**

```sql
id (uuid) PK
code (text, unique)
name (text)
category (text, nullable)
supplier_id (uuid, FK suppliers, nullable)
wholesale_price (numeric)
retail_price (numeric)
tax_rate (numeric, default 0)
stock_quantity (int)
created_at (timestamp)
updated_at (timestamp)
```

(Add indexes on `code`, `category` for queries.)

2. **sale_orders**

```sql
id (uuid) PK
customer_name (text)
contact_person (text)
email (text)
shipping_address (text, nullable)
delivery_date (date, nullable)
status (enum: 'draft', 'submitted', 'approved', 'fulfilled', 'rejected')
salesperson_id (uuid, FK users)
manager_id (uuid, FK users, nullable)
warehouse_id (uuid, FK users, nullable)
notes (text)
created_at (timestamp)
updated_at (timestamp)
```

(Add index on `status`.)

3. **order_items**

```sql
id (uuid) PK
order_id (uuid, FK sales_orders, ON DELETE CASCADE)
product_id (uuid, FK products)
quantity (int)
unit_price (numeric)
line_total (numeric)
is_in_stock (boolean)
line_status (enum: 'pending', 'fulfilled', 'backordered', default 'pending')
```

(Add index on `order_id`.)

4. **attachments**

```sql
id (uuid) PK
order_id (uuid, FK sales_orders, ON DELETE CASCADE)
file_url (text)
uploaded_by (uuid, FK users)
uploaded_at (timestamp)
```

5. **users**

```sql
id (uuid) PK
email (text, unique)
role (enum: 'salesperson', 'manager', 'warehouse')  -- Or separate roles table for multi-role
name (text)
created_at (timestamp)
```

6. **order_status_history** (for audit trail)

```sql
id (uuid) PK
order_id (uuid, FK sales_orders)
previous_status (text)
new_status (text)
changed_by (uuid, FK users)
changed_at (timestamp)
```

**Additional**: Enable Row-Level Security (RLS) in Supabase for role-based access. Add triggers for:

- Updating `stock_quantity` on fulfillment (deduct quantity from `products`).
- Logging to `order_status_history` on status changes.
  Consider soft-deletes (`deleted_at` timestamp) for orders instead of hard deletes.

(Note: Add a `suppliers` table if using `supplier_id`.)

## Frontend (React + MUI)

1. **Order Form Page**

- MUI DataGrid to list products, quantities, stock availability (with per-line status).
- Out-of-stock rows highlighted (read-only).
- Buttons: Save Draft, Submit, Approve, Reject, Add Note, Upload Proof (conditionally rendered by role).
- Integrate React Hook Form + Yup for client-side validation (e.g., quantity > 0, email format).
- Use Supabase Storage for file uploads with progress indicators and previews.

2. **Role-based Views**

- Salesperson: Create/edit drafts, submit.
- Manager: Review + Approve/Reject (with notifications of issues).
- Warehouse: Add note, upload proof, mark fulfilled (partial support via line statuses).

**Additional**: Use React Query or Zustand for state management and API handling. Ensure mobile responsiveness. Add i18n support (react-i18next) for multi-language if needed.

## Tech Stack

### Backend

- **Primary**: Next.js API Routes (Node.js, TypeScript)
  - Serverless APIs for CRUD operations (e.g., `/api/v1/orders`).
  - TypeScript for type safety, middleware for RBAC, and idempotency for actions.
- **Tools**: tRPC (optional for type-safe APIs), Zod (input validation).

### Database

- **Primary**: Supabase (Postgres)
  - Managed Postgres with RLS, real-time subscriptions, and auth.
  - Triggers for stock updates and audit trails.
- **Tools**: Prisma (ORM for type-safe queries), pgx (optional for raw SQL).

### Frontend

- **Primary**: React + Next.js (TypeScript) + MUI
  - React for dynamic UI, Next.js for SSR/static generation, MUI for accessible components (e.g., DataGrid).
- **Tools**: React Query (async state), React Hook Form + Yup (form validation), react-i18next (i18n).

### Authentication

- **Primary**: Supabase Auth
  - JWT-based auth with role management, integrated with RLS.
- **Tools**: Next.js Middleware (RBAC enforcement).

### File Storage

- **Primary**: Supabase Storage
  - Secure file uploads (e.g., packing proof photos) with progress indicators.

### Notifications

- **Primary**: SendGrid (via Supabase Edge Functions)
  - Email notifications for status changes (e.g., manager alerted on submit).
- **Tools**: Supabase Realtime (in-app notifications).

### Testing

- **Primary**: Jest + React Testing Library (unit), Cypress (E2E)
  - Jest for component/API tests, Cypress for role-based flow testing.
- **Tools**: Supabase CLI (DB mocks), msw (API mocks).

### Monitoring & Logging

- **Primary**: Sentry + Supabase Logs
  - Sentry for error tracking, Supabase Logs for DB actions.
- **Tools**: Mixpanel (usage analytics).

### Deployment

- **Primary**: Vercel
  - Optimized for Next.js with auto-scaling and CI/CD.
- **Tools**: GitHub Actions (CI/CD), Supabase CLI (DB migrations).

### Additional Tools

- ESLint + Prettier (code style), Husky (pre-commit checks), Docker (local dev).

## Additional Considerations

1. **Testing Strategy**

- Unit: Order validation functions (stock check, negatives, emails).
- Integration: API routes for order lifecycle (with auth mocks).
- E2E: Flow from draft → approval → fulfillment (use Cypress/Playwright for role simulations).

2. **Error Handling**

- Centralized API error wrapper (standardized JSON responses).
- UI: show MUI Snackbar for error/success messages.

3. **Accessibility (a11y)**

- ARIA labels for form controls.
- Ensure DataGrid is keyboard accessible.
- Color contrast for “out of stock” highlighting.

4. **Monitoring & Logging**

- Sentry for frontend/backend errors.
- Supabase logs for DB actions.
- Audit trail: track who updated orders at each stage (via `order_status_history`).

5. **Security**

- Auth/RBAC enforcement.
- Scan for OWASP vulnerabilities (e.g., SQL injection, XSS in notes).
- Use transactions/locks for inventory updates to prevent race conditions.

6. **Notifications**

- Integrate email/SMS (e.g., SendGrid via Supabase Edge Functions) for status changes (e.g., notify manager on submit).

7. **Analytics**

- Track usage with Mixpanel or Supabase metrics for iteration.

8. **Deployment**

- Host on Vercel (Next.js); CI/CD with GitHub Actions.
- Monitor Supabase costs (rows, storage).
